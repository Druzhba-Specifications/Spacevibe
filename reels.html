<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SpaceVibe by AlexNET | Reels</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
:root{--bg:#071426;--card:#0e1726;--accent:#00d9ff;--muted:#9fbfd6}
body{margin:0;background:var(--bg);color:#e6f7ff;font-family:Inter,Segoe UI,Arial}
.top{display:flex;justify-content:space-between;align-items:center;padding:12px;background:linear-gradient(180deg,#071725,#08192f);border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{color:var(--accent);font-weight:800}
.wrap{max-width:600px;margin:18px auto;padding:12px}
.composer{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
input,textarea{width:100%;padding:10px;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.05);margin-top:8px}
.btn{background:var(--accent);color:#012328;padding:8px 12px;border:none;border-radius:8px;font-weight:700;margin-top:6px;cursor:pointer}
.reel{background:#000;border-radius:12px;margin-top:16px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);position:relative}
.reel img,.reel video{width:100%;max-height:70vh;object-fit:cover;display:block}
.reelInfo{padding:10px}
.small{color:var(--muted);font-size:13px}
.actions{position:absolute;right:10px;top:20px;display:flex;flex-direction:column;gap:10px}
.abtn{background:rgba(255,255,255,0.15);border:none;color:white;width:40px;height:40px;border-radius:50%;font-size:17px;cursor:pointer}
.comment{background:#071726;border-radius:8px;padding:8px;margin-top:6px;border:1px solid rgba(255,255,255,0.03)}
</style>
</head>
<body>

<script>
if(!localStorage.getItem('sv_user')){location.href='index.html'}
</script>

<div class="top">
  <div class="brand">SpaceVibe by AlexNET</div>
  <a href="home.html" style="color:var(--accent);text-decoration:none;font-weight:700">Home</a>
</div>

<div class="wrap">
  <div class="composer">
    <input id="reelURL" placeholder="Image or .mp4/.webm URL"/>
    <textarea id="reelCap" rows="2" placeholder="Caption..."></textarea>
    <button class="btn" onclick="uploadReel()">Upload Reel</button>
  </div>

  <div id="reels"></div>
</div>

<script>
/* firebase init */
const firebaseConfig={apiKey:"AIzaSyCdJEX1GYr5ji2_uBR49oJ6z6WDC1cCY_Q",authDomain:"spacevibe-backend.firebaseapp.com",databaseURL:"https://spacevibe-backend-default-rtdb.firebaseio.com",projectId:"spacevibe-backend",storageBucket:"spacevibe-backend.firebasestorage.app",messagingSenderId:"258209625594",appId:"1:258209625594:web:a21c48b7e7100462012043"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* helpers */
const user=JSON.parse(localStorage.getItem('sv_user'));
function now(){return Date.now()}
function esc(s){return String(s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}

/* upload reel */
function uploadReel(){
  const url=reelURL.value.trim(),cap=reelCap.value.trim();
  if(!url)return alert("Enter URL");
  const id=now();
  const r={id,by:user.username,url,caption:cap,time:now(),likes:[],comments:{}};
  db.ref("reels/"+id).set(r);
  reelURL.value="";reelCap.value="";
}

/* realtime load */
db.ref("reels").on("value",snap=>{renderReels(snap.val()||{})});

function renderReels(list){
  reels.innerHTML="";
  Object.values(list).sort((a,b)=>b.time-a.time).forEach(r=>{
    const isVid=r.url.endsWith(".mp4")||r.url.endsWith(".webm");
    const liked=(r.likes||[]).includes(user.username);

    let media=isVid?
      `<video src="${esc(r.url)}" muted playsinline loop></video>`:
      `<img src="${esc(r.url)}">`;

    const box=document.createElement("div");
    box.className="reel";
    box.innerHTML=`
      ${media}
      <div class="actions">
        <button class="abtn" onclick="toggleReelLike('${r.id}')">${liked?"â™¥":"â™¡"}</button>
        <button class="abtn" onclick="commentBox('${r.id}')">ðŸ’¬</button>
      </div>
      <div class="reelInfo">
        <b>@${esc(r.by)}</b>
        <div>${esc(r.caption)}</div>
      </div>
      <div id="cArea-${r.id}">
        ${(r.comments?Object.values(r.comments):[]).map(c=>`
          <div class="comment"><b>@${esc(c.by)}</b> ${esc(c.text)}</div>
        `).join("")}
      </div>
      <div id="cBox-${r.id}" style="display:none;margin-top:6px">
        <input id="cInput-${r.id}" placeholder="Comment..." style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03)">
        <button class="btn" onclick="submitReelComment('${r.id}')">Send</button>
      </div>
    `;
    reels.appendChild(box);

    if(isVid){
      let v=box.querySelector("video");
      v.addEventListener("click",()=>{v.muted=!v.muted});
      let ob=new IntersectionObserver(entries=>{
        entries.forEach(e=>{if(e.isIntersecting)v.play();else v.pause()});
      },{threshold:0.6});
      ob.observe(v);
    }
  });
}

/* likes + comments */
function toggleReelLike(id){
  db.ref("reels/"+id+"/likes").once("value").then(s=>{
    let arr=s.val()||[];
    if(!Array.isArray(arr))arr=Object.values(arr);
    const i=arr.indexOf(user.username);
    if(i>-1)arr.splice(i,1);else arr.push(user.username);
    db.ref("reels/"+id+"/likes").set(arr);
  });
}
function commentBox(id){
  const el=document.getElementById("cBox-"+id);
  el.style.display=el.style.display==="block"?"none":"block";
}
function submitReelComment(id){
  const inp=document.getElementById("cInput-"+id);
  const t=inp.value.trim();if(!t)return;
  const cid=now();
  db.ref("reels/"+id+"/comments/"+cid).set({by:user.username,text:t,time:now()});
  inp.value="";
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>SpaceVibe â€” Neon Dark Pro</title>
<!-- md5 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
<!-- firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- CSS: one-line-per-selector, Neon Dark Pro -->
<style>
body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:#071426;color:#e6f7ff;-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:0 auto;padding:12px}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:#00e0ff;font-size:20px}
.tabs{display:flex;gap:8px}
.tab{background:transparent;border:none;color:#9fbfd6;padding:8px 12px;border-radius:10px;cursor:pointer}
.tab.active{background:linear-gradient(90deg,#00d9ff22,#66b3ff22);color:#002026;font-weight:800}
.adminBar{display:none;background:linear-gradient(180deg,#071826,#071426);padding:8px;border-radius:10px;margin:12px 0;border:1px solid rgba(0,200,255,0.06)}
.btn{background:#00d9ff;border:none;color:#012328;padding:9px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.card{background:linear-gradient(180deg,#07162a,#08192f);border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:12px;margin-bottom:12px}
.composer textarea{width:100%;min-height:70px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
.post{border-radius:12px;padding:12px;background:linear-gradient(180deg,#071725,#071427);border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
.postHeader{display:flex;gap:12px;align-items:center}
.pfp{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;background:linear-gradient(135deg,#00d9ff,#6a7cff);color:#012027}
.postMeta{color:#9fbfd6;font-size:13px}
.postText{margin-top:8px;white-space:pre-wrap}
.actions{display:flex;gap:10px;margin-top:10px}
.actionBtn{background:transparent;border:none;color:#9fbfd6;cursor:pointer}
.comment{background:#071726;border:1px solid rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:8px;color:#dff4ff}
.reelsFeed{display:flex;flex-direction:column;gap:14px}
.reel{position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:#000}
.reelMedia{width:100%;height:70vh;object-fit:cover;display:block}
.reelOverlay{position:absolute;left:16px;bottom:16px;color:#fff;max-width:70%}
.reelSidebar{position:absolute;right:12px;bottom:80px;display:flex;flex-direction:column;gap:12px}
.reelBtn{width:52px;height:52px;border-radius:50%;border:none;background:rgba(255,255,255,0.06);color:#fff;font-size:18px;cursor:pointer}
.chatList{max-height:360px;overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,0.03);padding:8px}
.chatItem{padding:8px;border-radius:8px;margin-bottom:6px;background:linear-gradient(180deg,#071726,#071423);cursor:pointer}
.chatWindow{min-height:220px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);padding:8px;display:flex;flex-direction:column;gap:6px}
.msg{padding:8px;border-radius:10px;max-width:70%}
.msg.me{align-self:flex-end;background:#00d9ff;color:#012328}
.msg.them{align-self:flex-start;background:#072033;color:#e6f7ff}
.profileCard{display:flex;gap:12px;align-items:center}
.settings{margin-top:12px;display:flex;flex-direction:column;gap:8px}
.small{font-size:13px;color:#9fbfd6}
.footerSpace{height:40px}
@media(max-width:880px){.reelMedia{height:56vh}}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">SpaceVibe</div>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="tabs">
        <button class="tab active" data-page="feed" onclick="switchPage('feed')">Feed</button>
        <button class="tab" data-page="reels" onclick="switchPage('reels')">Reels</button>
        <button class="tab" data-page="messages" onclick="switchPage('messages')">Messages</button>
        <button class="tab" data-page="profile" onclick="switchPage('profile')">Profile</button>
      </div>
      <div id="userDisplay" class="small"></div>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="adminBar" class="adminBar card">
    <button class="btn" onclick="renderAdminPanel()">Role Manager</button>
    <button class="btn" onclick="renderTakedownInbox()">Takedown Inbox</button>
  </div>

  <!-- Pages -->
  <div id="feed" class="card page">
    <div class="composer"><textarea id="postInput" placeholder="Whatâ€™s happening?"></textarea><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="createPost()">Post</button><button class="btn" onclick="openReelUploader()">Upload Reel</button></div></div>
    <div id="postsList" style="margin-top:14px"></div>
  </div>

  <div id="reels" class="card page" style="display:none">
    <div id="reelUploader" class="card" style="display:none">
      <input id="reelUrl" placeholder="video/image URL (mp4/webm for video)"><input id="reelCaption" placeholder="caption"><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="uploadReel()">Upload</button><button class="btn" onclick="closeReelUploader()">Cancel</button></div>
    </div>
    <div id="reelsFeed" class="reelsFeed"></div>
  </div>

  <div id="messages" class="card page" style="display:none">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <div class="small">Conversations</div>
        <div id="chatList" class="chatList"></div>
      </div>
      <div style="flex:2;min-width:240px">
        <div class="small" id="chatHeader">Select a conversation</div>
        <div id="chatWindow" class="chatWindow"></div>
        <div style="display:flex;gap:8px;margin-top:8px"><input id="chatInput" placeholder="Type a message..." style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)"><button class="btn" onclick="sendChat()">Send</button></div>
      </div>
    </div>
  </div>

  <div id="profile" class="card page" style="display:none">
    <div id="profileCard" class="profileCard"></div>
    <div class="settings card">
      <div class="small" style="font-weight:700">Settings</div>
      <input id="pfpUrl" placeholder="Profile image URL (web)"><div style="display:flex;gap:8px"><button class="btn" onclick="changePfp()">Change PFP</button><button class="btn" onclick="deleteAccount()">Delete Account</button></div>
    </div>
  </div>

  <div id="adminPanel" class="card" style="display:none"></div>
  <div id="takedownPanel" class="card" style="display:none"></div>
  <div class="footerSpace"></div>
</div>

<script>
/* Firebase init */
const firebaseConfig={apiKey:"AIzaSyCdJEX1GYr5ji2_uBR49oJ6z6WDC1cCY_Q",authDomain:"spacevibe-backend.firebaseapp.com",databaseURL:"https://spacevibe-backend-default-rtdb.firebaseio.com",projectId:"spacevibe-backend",storageBucket:"spacevibe-backend.firebasestorage.app",messagingSenderId:"258209625594",appId:"1:258209625594:web:a21c48b7e7100462012043"};firebase.initializeApp(firebaseConfig);const db=firebase.database();

/* State */
let user=null,allUsers={},allPosts={},allReels={},allMsgs={currentChat:null};

/* Roles */
const ROLE={FULL:"full-admin",ADMIN:"admin",CERT:"certified",REG:"regular"};

/* Helpers (one-line each per your request) */
function md5v(s){try{return md5(String(s||""))}catch(e){return String(s||"")}} 
function now(){return Date.now()} 
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")} 
function timeAgo(ts){let s=Math.floor((Date.now()-ts)/1000);if(s<60)return"just now";let m=Math.floor(s/60);if(m<60)return m+"m ago";let h=Math.floor(m/60);if(h<24)return h+"h ago";let d=Math.floor(h/24);return d+"d ago"} 
function saveLocal(){if(user)localStorage.setItem("sv_user",JSON.stringify(user))} 
function audit(action,details){let id=now().toString()+Math.random().toString(36).slice(2,6);db.ref("audit/"+id).set({id,by:user?user.username:"anon",action,details,time:now()})}

/* Auth (simple, md5 hashed password+email) */
function signup(){let u=document.getElementById("su_user").value.trim(),e=document.getElementById("su_email").value.trim(),p=document.getElementById("su_pass").value,b=document.getElementById("su_bio").value; if(!u||!p) return alert("username+password required"); db.ref("users/"+u).once("value").then(s=>{if(s.exists())return alert("username taken"); let emailHash=md5v(e), verified=(e==="alexsentme"); let obj={username:u,password:md5v(p),emailHash,verified,bio:b,joined:now(),role:ROLE.REG,certified:false,pfp:null,followers:[],following:[]}; db.ref("users/"+u).set(obj); user=obj; saveLocal(); audit("signup","user:"+u); startApp()})}
function login(){let u=document.getElementById("li_user").value.trim(),p=document.getElementById("li_pass").value; if(!u||!p) return alert("username+password required"); db.ref("users/"+u).once("value").then(s=>{if(!s.exists())return alert("no user"); let d=s.val(); if(d.password!==md5v(p))return alert("wrong password"); user=d; saveLocal(); audit("login","user:"+u); startApp()})}
function logout(){audit("logout","user:"+(user?user.username:"anon")); localStorage.removeItem("sv_user"); location.reload()}

/* Boot if session */
(function(){let s=localStorage.getItem("sv_user"); if(s){user=JSON.parse(s); startApp()} })()

/* Start app: bind realtime listeners and UI */
function startApp(){document.getElementById("auth")?.remove(); document.getElementById("userDisplay").textContent="@"+user.username; bindRealtime(); ensureAlex(); renderProfile(); switchPage("feed"); updateAdminBar()}

/* Realtime listeners (one-liners) */
function bindRealtime(){db.ref("users").on("value",s=>{allUsers=s.val()||{}; if(user&&allUsers[user.username])user=allUsers[user.username]; renderProfile(); renderChatList(); updateAdminBar();}); db.ref("posts").on("value",s=>{allPosts=s.val()||{}; renderPosts(); renderProfile();}); db.ref("reels").on("value",s=>{allReels=s.val()||{}; renderReels(); renderProfile();}); db.ref("messages").on("value",s=>{allMsgs=s.val()||{}; renderChat();}); db.ref("takedowns").on("value",s=>{}); db.ref("audit").limitToLast(30).on("value",s=>{})}

/* Ensure alexmaxxing exists and is full admin */
function ensureAlex(){db.ref("users/alexmaxxing").once("value").then(s=>{if(!s.exists()){db.ref("users/alexmaxxing").set({username:"alexmaxxing",password:md5v("password123"),emailHash:md5v("alex@local"),verified:true,bio:"Primary full admin",joined:now(),role:ROLE.FULL,certified:true,pfp:null,followers:[],following:[]}); audit("create_user","alex created")} else db.ref("users/alexmaxxing/role").set(ROLE.FULL)})}

/* Update admin bar visibility */
function updateAdminBar(){document.getElementById("adminBar").style.display=(user&&(user.role===ROLE.ADMIN||user.role===ROLE.FULL))?"block":"none"}

/* POSTS: create + render + like + comment + share */
function createPost(){if(!user)return alert("login"); let text=document.getElementById("postInput").value.trim(); if(!text) return; let id=now().toString(); let post={id,by:user.username,text,time:now(),likes:[],comments:{}}; db.ref("posts/"+id).set(post); document.getElementById("postInput").value=""; audit("create_post","post:"+id)}
function renderPosts(){let el=document.getElementById("postsList"); el.innerHTML=""; let arr=Object.values(allPosts||{}).sort((a,b)=>b.time-a.time); arr.forEach(p=>{ let liked=(p.likes||[]).includes(user.username); let s=document.createElement("div"); s.className="post"; s.innerHTML=`<div class='postHeader'><div class='pfp'>${esc(p.by[0]||"U")}</div><div><div style="font-weight:800">${esc(p.by)} ${renderBadge(p.by)}</div><div class='postMeta'>${timeAgo(p.time)}</div></div></div><div class='postText'>${esc(p.text)}</div><div class='actions'><button class='actionBtn' onclick="toggleLike('${p.id}')">${liked? "â™¥" : "â™¡"}</button><button class='actionBtn' onclick="openCommentPrompt('${p.id}')">ðŸ’¬</button>${renderFollowBtn(p.by)}${(user&&(user.role===ROLE.ADMIN||user.role===ROLE.FULL))?`<button class='actionBtn' onclick="requestTakedown('post','${p.id}')">ðŸš«</button>`:""}</div>`; let comments=p.comments||{}; Object.values(comments||[]).forEach(c=>{let d=document.createElement("div"); d.className="comment"; d.innerHTML=`<div class='small'><b>@${esc(c.by)}</b> â€¢ ${timeAgo(c.time)}</div><div>${esc(c.text)}</div>`; s.appendChild(d); }); el.appendChild(s); })}

/* Like/unlike post */
function toggleLike(id){ if(!user) return alert("login"); db.ref("posts/"+id+"/likes").once("value").then(s=>{ let arr=s.val()||[]; if(!Array.isArray(arr)) arr=Object.values(arr); let i=arr.indexOf(user.username); if(i>-1) arr.splice(i,1); else arr.push(user.username); db.ref("posts/"+id+"/likes").set(arr)})}

/* Comment prompt */
function openCommentPrompt(id){ if(!user) return alert("login"); let t=prompt("Comment:"); if(!t)return; let cid=now().toString(); db.ref("posts/"+id+"/comments/"+cid).set({id:cid,by:user.username,text:t,time:now()})}

/* FOLLOW / UNFOLLOW (updates both sides) */
function renderFollowBtn(target){ if(!user||target===user.username) return ""; let isFollowing=(user.following||[]).includes(target); return `<button class='actionBtn' onclick="${isFollowing?`unfollow('${target}')`:`follow('${target}')`}">${isFollowing? "Unfollow":"Follow"}</button>`}
function follow(target){ if(!user) return alert("login"); if(target===user.username) return; db.ref("users/"+user.username+"/following").once("value").then(s=>{let arr=s.val()||[]; if(!Array.isArray(arr)) arr=Object.values(arr); if(!arr.includes(target)) arr.push(target); db.ref("users/"+user.username+"/following").set(arr)}); db.ref("users/"+target+"/followers").once("value").then(s=>{let arr=s.val()||[]; if(!Array.isArray(arr)) arr=Object.values(arr); if(!arr.includes(user.username)) arr.push(user.username); db.ref("users/"+target+"/followers").set(arr)})}
function unfollow(target){ if(!user) return alert("login"); db.ref("users/"+user.username+"/following").once("value").then(s=>{let arr=s.val()||[]; if(!Array.isArray(arr)) arr=Object.values(arr); arr=arr.filter(x=>x!==target); db.ref("users/"+user.username+"/following").set(arr)}); db.ref("users/"+target+"/followers").once("value").then(s=>{let arr=s.val()||[]; if(!Array.isArray(arr)) arr=Object.values(arr); arr=arr.filter(x=>x!==user.username); db.ref("users/"+target+"/followers").set(arr)})}

/* REELS: hybrid behavior (autoplay for mp4/webm), upload, render */
function openReelUploader(){document.getElementById("reelUploader").style.display="block"; switchPage("reels")}
function closeReelUploader(){document.getElementById("reelUploader").style.display="none"}
function uploadReel(){ if(!user) return alert("login"); let url=document.getElementById("reelUrl").value.trim()||"https://placehold.co/600x800"; let caption=document.getElementById("reelCaption").value.trim(); let id=now().toString(); db.ref("reels/"+id).set({id,by:user.username,url,caption,time:now(),likes:[],comments:{}}); document.getElementById("reelUrl").value=""; document.getElementById("reelCaption").value=""; audit("create_reel","reel:"+id); closeReelUploader() }
function renderReels(){ let container=document.getElementById("reelsFeed"); container.innerHTML=""; let arr=Object.values(allReels||{}).sort((a,b)=>b.time-a.time); arr.forEach(r=>{ let isVideo=/(\.mp4|\.webm)(\?|$)/i.test(r.url); let liked=(r.likes||[]).includes(user.username); let el=document.createElement("div"); el.className="reel"; el.innerHTML=`${isVideo?`<video class='reelMedia' src='${esc(r.url)}' preload='metadata' playsinline muted loop></video>`:`<img class='reelMedia' src='${esc(r.url)}'/>`}<div class='reelOverlay'><div style='font-weight:800'>@${esc(r.by)} ${renderBadge(r.by)}</div><div style='margin-top:6px'>${esc(r.caption||"")}</div></div><div class='reelSidebar'><button class='reelBtn' onclick="toggleReelLike('${r.id}')">${liked? "â™¥":"â™¡"}</button><button class='reelBtn' onclick="openReelCommentPrompt('${r.id}')">ðŸ’¬</button>${(user&&(user.role===ROLE.ADMIN||user.role===ROLE.FULL))?`<button class='reelBtn' onclick="requestTakedown('reel','${r.id}')">ðŸš«</button>`:""}</div>`; container.appendChild(el); if(isVideo){ let v=el.querySelector("video"); let io=new IntersectionObserver(entries=>{entries.forEach(en=>{if(en.isIntersecting){v.muted=true;v.play().catch(()=>{});} else v.pause();})},{threshold:0.6}); io.observe(v);} })}

/* Reel like/comment */
function toggleReelLike(id){ if(!user) return alert("login"); db.ref("reels/"+id+"/likes").once("value").then(s=>{ let arr=s.val()||[]; if(!Array.isArray(arr)) arr=Object.values(arr); let i=arr.indexOf(user.username); if(i>-1) arr.splice(i,1); else arr.push(user.username); db.ref("reels/"+id+"/likes").set(arr) }) }
function openReelCommentPrompt(id){ if(!user) return alert("login"); let t=prompt("Comment:"); if(!t) return; db.ref("reels/"+id+"/comments/"+now().toString()).set({id:now().toString(),by:user.username,text:t,time:now()}) }

/* MESSAGING: mutual-follow required except alexmaxxing (who can message anyone) */
function renderChatList(){ let container=document.getElementById("chatList"); container.innerHTML=""; Object.values(allUsers||{}).forEach(u=>{ if(!u.username||u.username===user.username) return; let mine=(user.following||[]).includes(u.username); let theirs=(u.following||[]).includes(user.username); let can=(user.username==="alexmaxxing")||(mine&&theirs); let div=document.createElement("div"); div.className="chatItem"; div.innerHTML=`<div style='font-weight:800'>@${esc(u.username)} ${renderBadge(u.username)}</div><div class='small'>${can?'can chat':'mutual follow required'}</div>`; div.onclick=()=>{ if(!can) return alert('Mutual follow required'); document.getElementById("chatHeader").textContent="@"+u.username; currentChat=u.username; renderChat(); }; container.appendChild(div); }) }
function sendChat(){ if(!currentChat) return alert("select user"); let text=document.getElementById("chatInput").value.trim(); if(!text) return; let id=now().toString(); db.ref("messages/"+id).set({id,from:user.username,to:currentChat,text,time:now()}); document.getElementById("chatInput").value=""; }
function renderChat(){ let win=document.getElementById("chatWindow"); win.innerHTML=""; if(!currentChat) return; let conv=Object.values(allMsgs||{}).filter(m=>(m.from===user.username&&m.to===currentChat)||(m.from===currentChat&&m.to===user.username)).sort((a,b)=>a.time-b.time); conv.forEach(m=>{ let d=document.createElement("div"); d.className="msg "+(m.from===user.username?"me":"them"); d.textContent=m.text; win.appendChild(d); }) }

/* ADMIN: role manager + takedown inbox */
function renderAdminPanel(){ if(!(user&&(user.role===ROLE.FULL))) return alert("full-admin only"); let panel=document.getElementById("adminPanel"); panel.style.display="block"; let html="<h3>Role Manager</h3>"; Object.values(allUsers||{}).forEach(u=>{ html+=`<div style='display:flex;align-items:center;gap:8px;margin-top:8px'><div style='flex:1'>@${esc(u.username)} ${renderBadge(u.username)}</div><select id='role_${esc(u.username)}'><option value='regular'${u.role==='regular'?' selected':''}>Regular</option><option value='certified'${u.role==='certified'?' selected':''}>Certified</option><option value='admin'${u.role==='admin'?' selected':''}>Admin</option><option value='full-admin'${u.role==='full-admin'?' selected':''}>Full Admin</option></select><button class='btn' onclick="applyRole('${esc(u.username)}')">Apply</button></div>` }); panel.innerHTML=html }
function applyRole(u){ let sel=document.getElementById("role_"+u); if(!sel) return; let r=sel.value; db.ref("users/"+u+"/role").set(r); db.ref("users/"+u+"/certified").set(r==="certified"); audit("role_change",u+"->"+r); alert("role updated") }
function renderTakedownInbox(){ if(!(user&&(user.role===ROLE.FULL))) return alert("full-admin only"); let panel=document.getElementById("takedownPanel"); panel.style.display="block"; db.ref("takedowns").once("value").then(s=>{ let v=s.val()||{}; let html="<h3>Takedown Inbox</h3>"; Object.values(v).forEach(t=>{ html+=`<div style='padding:8px;border-top:1px solid rgba(255,255,255,0.03)'>Request: ${esc(t.type)} ${esc(t.id)} by @${esc(t.by)}<div>${esc(t.reason||"")}</div><div style='margin-top:6px'><button class='btn' onclick="approveTakedown('${t.key||t.id}','${t.type}','${t.id}')">Approve</button>&nbsp;<button class='btn' onclick="denyTakedown('${t.key||t.id}')">Deny</button></div></div>` }); panel.innerHTML=html }) }
function approveTakedown(key,type,id){ if(type==="post") db.ref("posts/"+id).remove(); if(type==="reel") db.ref("reels/"+id).remove(); db.ref("takedowns/"+key).remove(); alert("removed") }
function denyTakedown(key){ db.ref("takedowns/"+key).remove(); alert("denied") }

/* REQUEST TAKEDOWN (user) */
function requestTakedown(type,id){ let reason=prompt("Why remove this?"); if(!reason) return; let key=now().toString(); db.ref("takedowns/"+key).set({key,type,id,by:user.username,reason,time:now()}); alert("requested") }

/* BADGES & UTILS */
function renderBadge(username){ let u=allUsers[username]; if(!u) return ""; if(u.role==="full-admin") return "<span class='badge'>â˜… FULL</span>"; if(u.role==="admin") return "<span class='badge'>âœ“ ADMIN</span>"; if(u.role==="certified") return "<span class='badge' style='color:#00ffa8'>âœ” CERT</span>"; return "" }
function renderFollowBtn(username){ if(!user||user.username===username) return ""; let isFollowing=(user.following||[]).includes(username); return `<button class='actionBtn' onclick="${isFollowing?`unfollow('${username}')`:`follow('${username}')`}">${isFollowing?'Unfollow':'Follow'}</button>` }

/* PROFILE: display + change PFP + delete account */
function renderProfile(){ if(!user) return; let pc=document.getElementById("profileCard"); let pfpHtml=user.pfp?`<img src='${esc(user.pfp)}' style='width:72px;height:72px;border-radius:12px;object-fit:cover'>`:`<div class='pfp' style='width:72px;height:72px;font-size:28px'>${esc(user.username[0].toUpperCase())}</div>`; pc.innerHTML=`${pfpHtml}<div style='margin-left:8px'><div style='font-weight:800;font-size:18px'>@${esc(user.username)} ${renderBadge(user.username)}</div><div class='small' style='margin-top:6px'>${esc(user.bio||"")}</div><div style='margin-top:8px' class='small'>Followers: ${(user.followers||[]).length} Â· Following: ${(user.following||[]).length}</div></div>`; document.getElementById("userDisplay").textContent="@"+user.username }

/* Change PFP to a web image URL */
function changePfp(){ let url=document.getElementById("pfpUrl").value.trim(); if(!url) return alert("enter a web image URL"); db.ref("users/"+user.username+"/pfp").set(url).then(()=>{alert("updated"); document.getElementById("pfpUrl").value="";}) }

/* Delete account: remove user's posts, reels, messages, and user node */
function deleteAccount(){ if(!confirm("Delete account and all your data? This cannot be undone.")) return; let name=user.username; db.ref("users/"+name).remove(); db.ref("posts").once("value").then(s=>{ let v=s.val()||{}; Object.values(v).forEach(p=>{ if(p.by===name) db.ref("posts/"+p.id).remove() }) }); db.ref("reels").once("value").then(s=>{ let v=s.val()||{}; Object.values(v).forEach(r=>{ if(r.by===name) db.ref("reels/"+r.id).remove() }) }); db.ref("messages").once("value").then(s=>{ let v=s.val()||{}; Object.values(v).forEach(m=>{ if(m.from===name||m.to===name) db.ref("messages/"+m.id).remove() }) }); localStorage.removeItem("sv_user"); alert("deleted"); location.reload() }

/* CHAT HELPERS: current chat stored in currentChat variable */
let currentChat=null; window.currentChat=currentChat;

/* RENDER CHAT LIST and CHAT messages simplified (realtime updates handled earlier) */
function renderChatList(){ let node=document.getElementById("chatList"); node.innerHTML=""; Object.values(allUsers||{}).forEach(u=>{ if(!u.username||u.username===user.username) return; let mine=(user.following||[]).includes(u.username); let theirs=(u.following||[]).includes(user.username); let can=(user.username==="alexmaxxing")||(mine&&theirs); let div=document.createElement("div"); div.className="chatItem"; div.innerHTML=`<div style='font-weight:800'>@${esc(u.username)} ${renderBadge(u.username)}</div><div class='small'>${can?'can chat':'mutual follow required'}</div>`; div.onclick=()=>{ if(!can) return alert("Mutual follow required"); currentChat=u.username; document.getElementById("chatHeader").textContent="@"+currentChat; renderChat(); }; node.appendChild(div) }) }
function renderChat(){ let win=document.getElementById("chatWindow"); win.innerHTML=""; if(!currentChat) return; let conv=Object.values(allMsgs||{}).filter(m=> (m.from===user.username&&m.to===currentChat)||(m.from===currentChat&&m.to===user.username)).sort((a,b)=>a.time-b.time); conv.forEach(m=>{ let d=document.createElement("div"); d.className="msg "+(m.from===user.username?"me":"them"); d.textContent=m.text; win.appendChild(d) }) }
function sendChat(){ if(!currentChat) return alert("select a conversation"); let txt=document.getElementById("chatInput").value.trim(); if(!txt) return; let id=now().toString(); db.ref("messages/"+id).set({id,from:user.username,to:currentChat,text:txt,time:now()}); document.getElementById("chatInput").value="" }

/* Render badge helper (used in multiple places) already defined above as renderBadge */

/* Realtime rendering functions already used: renderPosts/renderReels/renderProfile/renderChatList/renderChat are called by listeners */

/* Toggle like helpers for simplicity on posts/reels included earlier */

/* Request takedown wrapper (user) already implemented (requestTakedown) */

/* Toggle page helper */
function switchPage(p){ document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")); document.querySelector(`[data-page="${p}"]`).classList.add("active"); document.getElementById("feed").style.display=(p==="feed")?"block":"none"; document.getElementById("reels").style.display=(p==="reels")?"block":"none"; document.getElementById("messages").style.display=(p==="messages")?"block":"none"; document.getElementById("profile").style.display=(p==="profile")?"block":"none" }

/* Realtime bindings already set in bindRealtime; implement bindRealtime here */
function bindRealtime(){ db.ref("users").on("value",s=>{ allUsers=s.val()||{}; if(user&&allUsers[user.username]) user=allUsers[user.username]; renderProfile(); renderChatList(); updateAdminBar(); }); db.ref("posts").on("value",s=>{ allPosts=s.val()||{}; renderPosts(); renderProfile(); }); db.ref("reels").on("value",s=>{ allReels=s.val()||{}; renderReels(); renderProfile(); }); db.ref("messages").on("value",s=>{ allMsgs=s.val()||{}; renderChat(); }); db.ref("takedowns").on("value",s=>{}); db.ref("audit").limitToLast(30).on("value",s=>{}) }

/* toggle like helpers for posts and reels (short wrappers) */
function toggleLike(id){ db.ref("posts/"+id+"/likes").once("value").then(s=>{ let a=s.val()||[]; if(!Array.isArray(a)) a=Object.values(a); let i=a.indexOf(user.username); if(i>-1) a.splice(i,1); else a.push(user.username); db.ref("posts/"+id+"/likes").set(a) }) }
function toggleReelLike(id){ db.ref("reels/"+id+"/likes").once("value").then(s=>{ let a=s.val()||[]; if(!Array.isArray(a)) a=Object.values(a); let i=a.indexOf(user.username); if(i>-1) a.splice(i,1); else a.push(user.username); db.ref("reels/"+id+"/likes").set(a) }) }

/* request takedown wrapper (already above) */

/* initial minimal render implementations to avoid undefined errors */
function renderPosts(){} function renderReels(){} function renderProfile(){} function renderChatList(){} function renderChat(){} 

/* Kickstart: set minimal functions to previous defined ones (reassign proper implementations) */
renderPosts = window.renderPosts || renderPosts; renderReels = window.renderReels || renderReels; renderProfile = window.renderProfile || renderProfile; renderChatList = window.renderChatList || renderChatList; renderChat = window.renderChat || renderChat;

/* initialize realtime listeners if user was already loaded from localStorage (session resume) */
(function(){ let s=localStorage.getItem("sv_user"); if(s){ user=JSON.parse(s); startApp(); } else { /* show auth UI remains visible */ } })()
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SpaceVibe â€” fake verification + hashed email</title>

<!-- md5 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
<!-- firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
  /* compact styles (kept similar to earlier) */
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial,Helvetica,sans-serif;background:#111827;color:#fff;min-height:100vh}
  .center{max-width:1100px;margin:18px auto;padding:16px}
  .splash{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(120deg,#0b1221,#0f1724)}
  .card{background:#0f1724;border:1px solid #1f2937;border-radius:10px;padding:18px}
  h1{color:#00d9ff;font-weight:900;margin-bottom:8px}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #24303f;background:#061226;color:#fff;margin-bottom:8px}
  .btn{background:#00d9ff;color:#022032;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .topbar{background:#0b1221;padding:10px 16px;border-bottom:1px solid #18202b;position:sticky;top:0;z-index:50}
  .tabs{display:flex;gap:8px;align-items:center}
  .tab{background:transparent;border:none;color:#94a3b8;padding:8px 12px;border-radius:8px;cursor:pointer}
  .tab.active{background:#00d9ff;color:#022032;font-weight:700}
  .layout{display:flex;gap:16px;margin-top:16px}
  .col{flex:1}
  .sidebar{width:300px}
  .pfp{width:44px;height:44px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#00d9ff,#667eea);font-weight:900;margin-right:10px}
  .post{background:#0b1520;border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid #172433}
  .post-top{display:flex;align-items:center}
  .post-text{margin-top:10px;line-height:1.4}
  .post-actions{display:flex;gap:10px;margin-top:10px}
  .action-btn{background:none;border:none;color:#9fb3c8;cursor:pointer}
  .comment{background:#071226;padding:8px;border-radius:8px;margin-top:8px;border:1px solid #14242f}
  .contacts{background:#071226;padding:8px;border-radius:8px;border:1px solid #14242f}
  .admin-bar{display:none;background:#07122a;padding:10px;border-top:1px solid #122033}
  .badge{color:#00d9ff;font-weight:800;margin-left:6px}
  .small{font-size:12px;color:#94a3b8}
  .panel{background:#071226;padding:10px;border-radius:8px;border:1px solid #122033;margin-bottom:10px}
  @media (max-width:900px){.layout{flex-direction:column}.sidebar{width:100%}}
</style>
</head>
<body>

<!-- Splash / Auth -->
<div id="splash" class="splash">
  <div class="center">
    <div class="card">
      <h1>SpaceVibe</h1>
      <p class="small">your corner of the internet â€” fake verification (hashed email)</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div>
          <h3 style="margin-bottom:6px">Sign up</h3>
          <form id="signupForm">
            <input id="signupUser" placeholder="username" required />
            <input id="signupEmail" placeholder="email (or put 'alexsentme' to auto-verify)" />
            <input id="signupPass" type="password" placeholder="password" required />
            <textarea id="signupBio" placeholder="about you..." rows="3"></textarea>
            <button class="btn" type="submit">Create account</button>
          </form>
        </div>
        <div>
          <h3 style="margin-bottom:6px">Log in</h3>
          <form id="loginForm">
            <input id="loginUser" placeholder="username" required />
            <input id="loginPass" type="password" placeholder="password" required />
            <button class="btn" type="submit">Enter</button>
          </form>
        </div>
      </div>
      <div style="margin-top:12px" class="small">
        Note: Emails are not actually emailed. We store <b>md5(email)</b>. Using email value <code>alexsentme</code> sets emailVerified = true.
      </div>
    </div>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="topbar">
    <div class="center" style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;align-items:center;gap:12px">
        <h1 style="margin:0">SpaceVibe</h1>
        <div class="tabs" id="mainTabs">
          <button class="tab active" data-page="feed">Feed</button>
          <button class="tab" data-page="reels">Reels</button>
          <button class="tab" data-page="messages">Messages</button>
          <button class="tab" data-page="profile">Profile</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div id="currentUserDisplay" class="small"></div>
        <button class="btn" id="logout">Logout</button>
      </div>
    </div>
    <div id="adminBar" class="admin-bar center">
      <button class="btn" id="openAdminPanelBtn">Admin Panel</button>
      <button class="btn" id="openTakedownInboxBtn">Takedown Inbox</button>
    </div>
  </div>

  <div class="center">
    <div id="adminPanel" class="panel" style="display:none"></div>
    <div id="takedownPanel" class="panel" style="display:none"></div>

    <div class="layout">
      <div class="col">
        <!-- Feed -->
        <div id="feedPage" class="page">
          <div class="panel">
            <textarea id="postText" placeholder="What's happening?" rows="3"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="postBtn">Post</button>
              <button class="btn" id="createReelQuick">Post Reel</button>
            </div>
          </div>
          <div id="posts"></div>
        </div>

        <!-- Reels -->
        <div id="reelsPage" class="page" style="display:none">
          <div class="panel">
            <input id="reelUrl" placeholder="video url (optional)"/>
            <textarea id="reelCaption" placeholder="caption..." rows="2"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="reelBtn">Post Reel</button>
            </div>
          </div>
          <div id="reels"></div>
        </div>

        <!-- Messages -->
        <div id="messagesPage" class="page" style="display:none">
          <div class="layout" style="gap:8px">
            <div class="sidebar">
              <div class="contacts card">
                <h4>People</h4>
                <div id="contactList"></div>
              </div>
            </div>
            <div style="flex:1">
              <div class="card">
                <div id="chatHead" class="small">pick someone to chat</div>
                <div id="chatBox" style="height:320px;overflow:auto;margin-top:8px"></div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input id="msgInput" placeholder="Message..." />
                  <button class="btn" id="sendBtn">Send</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile -->
        <div id="profilePage" class="page" style="display:none">
          <div class="card">
            <div style="display:flex;align-items:center;gap:12px">
              <div class="pfp" id="profPfp"></div>
              <div>
                <div id="profName"></div>
                <div id="profBadge" class="small"></div>
                <div id="profBio" class="small" style="margin-top:6px"></div>
              </div>
            </div>
            <div style="display:flex;gap:12px;margin-top:12px">
              <div class="small">Posts: <span id="postStat">0</span></div>
              <div class="small">Reels: <span id="reelStat">0</span></div>
              <div class="small">Followers: <span id="followersStat">0</span></div>
              <div class="small">Following: <span id="followingStat">0</span></div>
            </div>
          </div>
        </div>

      </div>

      <div class="sidebar">
        <div class="panel">
          <h4>Quick actions</h4>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button class="btn" id="openMyProfile">My Profile</button>
            <button class="btn" id="openFeed">Feed</button>
          </div>
        </div>

        <div class="panel" id="notificationsPanel">
          <h4>Notifications</h4>
          <div id="notificationsList" class="small"></div>
        </div>

        <div class="panel">
          <h4>Admin Audit</h4>
          <div id="auditList" class="small"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* --------------------------
   Firebase config â€” replace if needed
   -------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCdJEX1GYr5ji2_uBR49oJ6z6WDC1cCY_Q",
  authDomain: "spacevibe-backend.firebaseapp.com",
  projectId: "spacevibe-backend",
  storageBucket: "spacevibe-backend.firebasestorage.app",
  messagingSenderId: "258209625594",
  appId: "1:258209625594:web:a21c48b7e7100462012043"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* --------------------------
   Roles & state
   -------------------------- */
const ROLE = {
  FULL_ADMIN: "full-admin",
  ADMIN: "admin",
  CERTIFIED: "certified",
  REGULAR: "regular"
};

let user = null;
let allUsers = {};
let allPosts = [];
let allReels = [];
let allMsgs = [];
let reelIdx = 0;
let chatWith = null;

/* --------------------------
   Helpers
   -------------------------- */
function md5v(s){ try { return md5(String(s)); } catch(e){ return String(s); } }
function now(){ return Date.now(); }
function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function logAudit(action, details){
  const id = Date.now().toString() + Math.random().toString(36).slice(2,8);
  db.ref('audit/' + id).set({id, by: user ? user.username : 'anon', action, details, time: now()});
}

/* --------------------------
   Load saved session (username)
   -------------------------- */
function loadSession(){
  const saved = JSON.parse(localStorage.getItem('user') || 'null');
  if(saved && saved.username){
    db.ref('users/' + saved.username).once('value').then(snap => {
      if(snap.exists()){
        user = snap.val();
        localStorage.setItem('user', JSON.stringify(user));
        showApp();
        attachListeners();
        startListeners();
      } else {
        localStorage.removeItem('user');
      }
    });
  }
}
loadSession();

/* --------------------------
   Start realtime listeners
   -------------------------- */
function startListeners(){
  db.ref('users').on('value', snap => {
    allUsers = snap.val() || {};
    ensureAlex();
    renderContacts();
    renderProfile();
    renderAdminPanel();
    renderPosts();
    renderReels();
    renderAudit();
  });

  db.ref('posts').on('value', snap => {
    const data = snap.val() || {};
    allPosts = Object.keys(data).map(k => {
      const p = data[k]; p.id = k; p.likes = p.likes || []; p.shares = p.shares || 0; p.comments = p.comments || {}; return p;
    }).sort((a,b)=>b.time-a.time);
    renderPosts();
    renderProfile();
  });

  db.ref('reels').on('value', snap => {
    const data = snap.val() || {};
    allReels = Object.keys(data).map(k=>{const r=data[k]; r.id=k; r.likes=r.likes||[]; return r;}).sort((a,b)=>b.time-a.time);
    renderReels();
    renderProfile();
  });

  db.ref('messages').on('value', snap => {
    const data = snap.val() || {};
    allMsgs = Object.keys(data).map(k=>{const m=data[k]; m.id=k; return m;}).sort((a,b)=>a.time-b.time);
    renderChat();
  });

  db.ref('takedowns').on('value', snap=>{
    renderTakedownPanel(); // update inbox
  });

  db.ref('audit').limitToLast(50).on('value', snap=>{
    renderAudit();
  });
}

/* --------------------------
   Ensure alexmaxxing exists and is full-admin
   -------------------------- */
function ensureAlex(){
  if(!allUsers['alexmaxxing']){
    const u = {
      username: 'alexmaxxing',
      password: md5v('password123'),
      emailHash: md5v('alex@local'),
      emailVerified: true,
      bio: 'primary full admin',
      joined: now(),
      role: ROLE.FULL_ADMIN,
      certified: true,
      followers: [],
      following: []
    };
    db.ref('users/alexmaxxing').set(u);
    logAudit('create_user','auto-created alexmaxxing');
    return;
  }
  // enforce full-admin cert for alex
  const a = allUsers['alexmaxxing'];
  if(a.role !== ROLE.FULL_ADMIN || !a.certified){
    db.ref('users/alexmaxxing/role').set(ROLE.FULL_ADMIN);
    db.ref('users/alexmaxxing/certified').set(true);
  }
}

/* --------------------------
   Auth (custom fake verification)
   -------------------------- */
document.getElementById('signupForm').onsubmit = async (e) => {
  e.preventDefault();
  const username = document.getElementById('signupUser').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const pass = document.getElementById('signupPass').value;
  const bio = document.getElementById('signupBio').value.trim();

  if(!username || !pass) return alert('username & password required');

  const snap = await db.ref('users/' + username).once('value');
  if(snap.exists()) return alert('username taken');

  const emailHash = md5v(email || '');
  const emailVerified = (email === 'alexsentme');

  const newUser = {
    username,
    password: md5v(pass),
    emailHash,
    emailVerified,
    bio,
    joined: now(),
    role: ROLE.REGULAR,
    certified: false,
    followers: [],
    following: []
  };

  await db.ref('users/' + username).set(newUser);
  user = newUser;
  localStorage.setItem('user', JSON.stringify(user));
  logAudit('signup', 'user:' + username);
  showApp();
  startListeners();
};

document.getElementById('loginForm').onsubmit = async (e) => {
  e.preventDefault();
  const username = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!username || !pass) return;

  const snap = await db.ref('users/' + username).once('value');
  if(snap.exists() && snap.val().password === md5v(pass)){
    user = snap.val();
    localStorage.setItem('user', JSON.stringify(user));
    logAudit('login','user:'+username);
    showApp();
    startListeners();
  } else {
    alert('wrong username or password');
  }
};

document.getElementById('logout').onclick = ()=>{
  logAudit('logout','user:' + (user?user.username:'anon'));
  user = null; localStorage.removeItem('user');
  document.getElementById('app').style.display = 'none';
  document.getElementById('splash').style.display = 'flex';
};

/* --------------------------
   UI show
   -------------------------- */
function showApp(){
  document.getElementById('splash').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('currentUserDisplay').textContent = user ? '@'+user.username : '';
  updateAdminBar();
  renderProfile();
  renderNotifications();
}

/* Tabs */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    const page = (t.dataset.page||'feed') + 'Page';
    document.getElementById(page).style.display = 'block';
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    t.classList.add('active');
  };
});

/* --------------------------
   Posts (create/read/like/comment/share)
   -------------------------- */
document.getElementById('postBtn').onclick = async ()=>{
  if(!user) return alert('log in');
  const text = document.getElementById('postText').value.trim();
  if(!text) return;
  const id = now().toString();
  const post = { id, user: user.username, text, likes: [], shares: 0, time: now(), comments: {} };
  await db.ref('posts/' + id).set(post);
  document.getElementById('postText').value = '';
  logAudit('create_post','post:' + id + ' by ' + user.username);
};

function renderPosts(){
  const box = document.getElementById('posts');
  box.innerHTML = '';
  allPosts.forEach(p=>{
    const liked = (p.likes||[]).includes(user?.username);
    const el = document.createElement('div'); el.className='post';
    el.innerHTML = `
      <div class="post-top"><div class="pfp">${p.user[0].toUpperCase()}</div>
        <div>
          <div><b>${p.user}</b> ${renderBadge(p.user)} <span class="small">â€¢ ${timeAgo(p.time)}</span></div>
        </div>
      </div>
      <div class="post-text">${escapeHtml(p.text)}</div>
      <div class="post-actions">
        <button class="action-btn" onclick="toggleLikePost('${p.id}')">${liked ? 'â™¥' : 'â™¡'} ${(p.likes||[]).length}</button>
        <button class="action-btn" onclick="openCommentBox('${p.id}')">ðŸ’¬ ${Object.keys(p.comments||{}).length}</button>
        <button class="action-btn" onclick="sharePost('${p.id}')">â†— ${p.shares||0}</button>
        ${(user && (user.role===ROLE.ADMIN||user.role===ROLE.FULL_ADMIN)) ? `<button class="action-btn" onclick="requestTakedown('${p.id}')">ðŸš« takedown</button>` : ''}
      </div>
      <div id="comments-${p.id}"></div>
      <div id="commentbox-${p.id}" style="margin-top:8px;display:none">
        <input id="comment-input-${p.id}" placeholder="Write a comment..." />
        <div style="margin-top:6px"><button class="btn" onclick="submitComment('${p.id}')">Comment</button></div>
      </div>
    `;
    box.appendChild(el);
    renderCommentsFor(p.id);
  });
}

async function toggleLikePost(id){
  if(!user) return alert('log in');
  const ref = db.ref('posts/' + id + '/likes');
  const snap = await ref.once('value');
  let likes = snap.val() || [];
  if(!Array.isArray(likes)) likes = Object.values(likes);
  const i = likes.indexOf(user.username);
  if(i>-1) likes.splice(i,1); else likes.push(user.username);
  await ref.set(likes);
  logAudit('like_post','post:'+id + ' by ' + user.username);
}

async function submitComment(postId){
  if(!user) return alert('log in');
  const input = document.getElementById('comment-input-' + postId);
  const text = input.value.trim();
  if(!text) return;
  const id = now().toString();
  const comment = { id, by: user.username, text, time: now() };
  await db.ref('posts/' + postId + '/comments/' + id).set(comment);
  input.value = '';
  logAudit('comment','post:'+postId + ' comment:'+id);
  renderCommentsFor(postId);
}

function openCommentBox(postId){
  const box = document.getElementById('commentbox-' + postId);
  if(box) box.style.display = box.style.display==='block' ? 'none' : 'block';
}

function renderCommentsFor(postId){
  const p = allPosts.find(x=>x.id===postId); if(!p) return;
  const box = document.getElementById('comments-' + postId);
  if(!box) return;
  box.innerHTML = '';
  const comments = p.comments || {};
  Object.keys(comments).sort((a,b)=>comments[a].time - comments[b].time).forEach(k=>{
    const c = comments[k];
    const div = document.createElement('div'); div.className='comment';
    div.innerHTML = `<div class="small"><b>${c.by}</b> â€¢ ${timeAgo(c.time)}</div><div style="margin-top:6px">${escapeHtml(c.text)}</div>`;
    box.appendChild(div);
  });
}

async function sharePost(id){
  if(!user) return alert('log in');
  const ref = db.ref('posts/' + id + '/shares');
  const snap = await ref.once('value');
  let s = snap.val() || 0;
  s = Number(s) + 1;
  await ref.set(s);
  logAudit('share_post','post:'+id+' by '+user.username);
}

/* --------------------------
   Reels
   -------------------------- */
document.getElementById('reelBtn').onclick = async ()=>{
  if(!user) return alert('log in');
  const cap = document.getElementById('reelCaption').value.trim();
  const url = document.getElementById('reelUrl').value.trim();
  if(!cap) return alert('caption required');
  const id = now().toString();
  const r = { id, user: user.username, caption: cap, url: url||null, likes: [], time: now() };
  await db.ref('reels/' + id).set(r);
  document.getElementById('reelCaption').value=''; document.getElementById('reelUrl').value='';
  logAudit('create_reel','reel:'+id+' by '+user.username);
};

function renderReels(){
  const box = document.getElementById('reels');
  box.innerHTML = '';
  allReels.forEach(r=>{
    const liked = (r.likes||[]).includes(user?.username);
    const el = document.createElement('div'); el.className='post';
    el.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="pfp">${r.user[0].toUpperCase()}</div><div><b>${r.user}</b> ${renderBadge(r.user)}<div class="small">${timeAgo(r.time)}</div></div></div>
      <div style="margin-top:8px">${escapeHtml(r.caption)}</div>
      ${r.url?'<div style="margin-top:8px"><img src="'+r.url+'" style="width:100%;border-radius:8px" /></div>':''}
      <div style="margin-top:8px"><button class="action-btn" onclick="likeReel('${r.id}')">${liked?'â™¥':'â™¡'} ${(r.likes||[]).length}</button></div>`;
    box.appendChild(el);
  });
}

async function likeReel(id){
  if(!user) return alert('log in');
  const ref = db.ref('reels/' + id + '/likes');
  const snap = await ref.once('value');
  let likes = snap.val() || [];
  if(!Array.isArray(likes)) likes = Object.values(likes);
  const idx = likes.indexOf(user.username);
  if(idx>-1) likes.splice(idx,1); else likes.push(user.username);
  await ref.set(likes);
  logAudit('like_reel','reel:'+id);
}

/* --------------------------
   Messages
   -------------------------- */
function renderContacts(){
  const box = document.getElementById('contactList'); box.innerHTML='';
  Object.keys(allUsers).filter(u=>u!==user?.username).forEach(u=>{
    const div=document.createElement('div'); div.style.display='flex'; div.style.alignItems='center'; div.style.gap='8px'; div.style.padding='6px'; div.style.cursor='pointer';
    div.innerHTML=`<div class="pfp">${u[0].toUpperCase()}</div><div style="flex:1">${u} ${renderBadge(u)}</div>`;
    div.onclick = ()=>{ chatWith = u; renderChat(); };
    box.appendChild(div);
  });
}

function renderChat(){
  const head = document.getElementById('chatHead');
  const box = document.getElementById('chatBox');
  if(!chatWith){ head.textContent='pick someone to chat'; box.innerHTML=''; return; }
  head.textContent = chatWith;
  const convo = allMsgs.filter(m=>(m.from===user.username && m.to===chatWith) || (m.from===chatWith && m.to===user.username));
  box.innerHTML = '';
  convo.forEach(m=>{
    const d = document.createElement('div'); d.className='small'; d.style.margin='6px'; d.style.textAlign = (m.from===user.username?'right':'left');
    d.textContent = `${m.from}: ${m.text}`;
    box.appendChild(d);
  });
  box.scrollTop = box.scrollHeight;
}

document.getElementById('sendBtn').onclick = async ()=>{
  if(!user) return alert('log in');
  if(!chatWith) return alert('pick someone');
  const txt = document.getElementById('msgInput').value.trim(); if(!txt) return;
  const id = now().toString();
  const m = { id, from: user.username, to: chatWith, text: txt, time: now() };
  await db.ref('messages/' + id).set(m);
  document.getElementById('msgInput').value='';
  logAudit('message','to:'+chatWith);
};

/* --------------------------
   Follow / Unfollow
   -------------------------- */
async function follow(username){
  if(!user) return alert('log in');
  if(username === user.username) return;
  // add to following list of current user, add to followers list of target
  const aRef = db.ref('users/' + user.username + '/following');
  const bRef = db.ref('users/' + username + '/followers');

  const aSnap = await aRef.once('value'); let following = aSnap.val() || [];
  if(!Array.isArray(following)) following = Object.values(following);
  if(!following.includes(username)) following.push(username);
  await aRef.set(following);

  const bSnap = await bRef.once('value'); let followers = bSnap.val() || [];
  if(!Array.isArray(followers)) followers = Object.values(followers);
  if(!followers.includes(user.username)) followers.push(user.username);
  await bRef.set(followers);

  logAudit('follow',''+user.username+'->'+username);
}

async function unfollow(username){
  if(!user) return alert('log in');
  const aRef = db.ref('users/' + user.username + '/following');
  const bRef = db.ref('users/' + username + '/followers');

  const aSnap = await aRef.once('value'); let following = aSnap.val() || [];
  if(!Array.isArray(following)) following = Object.values(following);
  following = following.filter(x=>x!==username);
  await aRef.set(following);

  const bSnap = await bRef.once('value'); let followers = bSnap.val() || [];
  if(!Array.isArray(followers)) followers = Object.values(followers);
  followers = followers.filter(x=>x!==user.username);
  await bRef.set(followers);

  logAudit('unfollow',''+user.username+'->'+username);
}

/* --------------------------
   Admin panel & role change
   -------------------------- */
function updateAdminBar(){ document.getElementById('adminBar').style.display = (user && (user.role===ROLE.ADMIN || user.role===ROLE.FULL_ADMIN)) ? 'block' : 'none'; }
document.getElementById('openAdminPanelBtn').onclick = ()=> {
  if(!user || user.role !== ROLE.FULL_ADMIN) return alert('full-admins only');
  const p = document.getElementById('adminPanel'); p.style.display = p.style.display==='block' ? 'none' : 'block'; renderAdminPanel();
};

function renderAdminPanel(){
  const panel = document.getElementById('adminPanel'); panel.innerHTML = '<h4>Role Manager</h4>';
  Object.keys(allUsers).forEach(u=>{
    panel.innerHTML += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <div style="flex:1"><b>@${u}</b> ${renderBadge(u)}</div>
      <select id="role-select-${u}"><option value="${ROLE.REGULAR}">Regular</option><option value="${ROLE.CERTIFIED}">Certified</option><option value="${ROLE.ADMIN}">Admin</option><option value="${ROLE.FULL_ADMIN}">Full Admin</option></select>
      <button class="btn" onclick="applyRole('${u}')">Apply</button>
    </div>`;
    setTimeout(()=>{ const el=document.getElementById('role-select-'+u); if(el) el.value = allUsers[u].role || ROLE.REGULAR; },50);
  });
}

function applyRole(u){
  const sel = document.getElementById('role-select-'+u); if(!sel) return;
  const newRole = sel.value;
  db.ref('users/' + u + '/role').set(newRole);
  db.ref('users/' + u + '/certified').set(newRole === ROLE.CERTIFIED);
  logAudit('role_change', u + ' -> ' + newRole + ' by ' + user.username);
  alert('Role updated.');
}

/* --------------------------
   Takedown flow
   -------------------------- */
async function requestTakedown(postId){
  if(!user) return alert('log in');
  const reason = prompt('Reason for takedown:');
  if(!reason) return;
  const id = now().toString();
  const req = { id, postId, from: user.username, reason, time: now(), handled:false, approved:false };
  await db.ref('takedowns/' + id).set(req);
  logAudit('takedown_request','post:'+postId+' by '+user.username);
  alert('Takedown requested.');
}

document.getElementById('openTakedownInboxBtn').onclick = ()=>{
  if(!user || user.role !== ROLE.FULL_ADMIN) return alert('full-admins only');
  const p = document.getElementById('takedownPanel'); p.style.display=p.style.display==='block'?'none':'block'; renderTakedownPanel();
};

function renderTakedownPanel(){
  const panel = document.getElementById('takedownPanel'); panel.innerHTML='<h4>Takedown Inbox</h4>';
  db.ref('takedowns').once('value').then(snap=>{
    const list = snap.val() || {};
    if(!Object.keys(list).length) panel.innerHTML += '<div class="small">No requests</div>';
    else {
      Object.keys(list).forEach(k=>{
        const r = list[k];
        panel.innerHTML += `<div style="padding:8px;border-bottom:1px solid #122033;margin-bottom:6px">
          <div><b>Post</b> ${r.postId} <span class="small">by @${r.from} â€¢ ${timeAgo(r.time)}</span></div>
          <div style="margin-top:6px">${escapeHtml(r.reason)}</div>
          <div style="margin-top:8px"><button class="btn" onclick="approveTakedown('${r.id}','${r.postId}')">Approve</button> <button class="btn" onclick="denyTakedown('${r.id}')">Deny</button></div>
        </div>`;
      });
    }
  });
}

async function approveTakedown(reqId, postId){
  await db.ref('posts/' + postId).remove();
  await db.ref('takedowns/' + reqId).remove();
  logAudit('takedown_approved','post:'+postId+' by '+user.username);
  alert('Post removed.');
}

async function denyTakedown(reqId){
  await db.ref('takedowns/' + reqId).remove();
  logAudit('takedown_denied','req:'+reqId+' by '+user.username);
  alert('Request denied.');
}

/* --------------------------
   Badge / UI helpers
   -------------------------- */
function renderBadge(username){
  const u = allUsers[username];
  if(!u) return '';
  if(u.role===ROLE.FULL_ADMIN) return '<span class="badge">â˜… FULL ADMIN</span>';
  if(u.role===ROLE.ADMIN) return '<span class="badge">âœ“ ADMIN</span>';
  if(u.role===ROLE.CERTIFIED) return '<span style="color:#00ff9d;font-weight:700;margin-left:6px">âœ” CERTIFIED</span>';
  return '';
}

function timeAgo(ts){
  const s = Math.floor((Date.now()-ts)/1000); if(s<60) return 'just now';
  const m = Math.floor(s/60); if(m<60) return m+'m ago';
  const h = Math.floor(m/60); if(h<24) return h+'h ago';
  const d = Math.floor(h/24); return d+'d ago';
}

/* --------------------------
   Notifications & Audit display
   -------------------------- */
function renderNotifications(){
  const list = document.getElementById('notificationsList'); list.innerHTML='';
  // Very simple: show last few audit entries as notifications for demo
  db.ref('audit').limitToLast(10).once('value').then(snap=>{
    const vals = snap.val() || {};
    Object.keys(vals).reverse().forEach(k=>{
      const a = vals[k];
      list.innerHTML += `<div>${escapeHtml(a.by)} â€¢ ${escapeHtml(a.action)} <div class="small">${timeAgo(a.time)}</div></div>`;
    });
  });
}

function renderAudit(){
  const box = document.getElementById('auditList'); box.innerHTML='';
  db.ref('audit').limitToLast(10).once('value').then(snap=>{
    const vals = snap.val() || {};
    Object.keys(vals).reverse().forEach(k=>{
      const a = vals[k];
      box.innerHTML += `<div>${escapeHtml(a.by)} â€¢ ${escapeHtml(a.action)} <div class="small">${timeAgo(a.time)}</div></div>`;
    });
  });
}

/* --------------------------
   Render profile stats
   -------------------------- */
function renderProfile(){
  if(!user) return;
  document.getElementById('profPfp').textContent = user.username[0].toUpperCase();
  document.getElementById('profName').textContent = user.username;
  document.getElementById('profBadge').innerHTML = renderBadge(user.username);
  document.getElementById('profBio').textContent = user.bio || 'no bio yet';
  document.getElementById('postStat').textContent = allPosts.filter(p=>p.user===user.username).length;
  document.getElementById('reelStat').textContent = allReels.filter(r=>r.user===user.username).length;
  document.getElementById('followersStat').textContent = (user.followers || []).length;
  document.getElementById('followingStat').textContent = (user.following || []).length;
}

/* --------------------------
   Misc UI helpers and boot
   -------------------------- */
function attachListeners(){
  document.getElementById('openFeed').onclick = ()=>{ document.querySelector('[data-page="feed"]').click(); };
  document.getElementById('openMyProfile').onclick = ()=>{ document.querySelector('[data-page="profile"]').click(); };
  document.getElementById('createReelQuick').onclick = ()=>{ document.querySelector('[data-page="reels"]').click(); };
  document.getElementById('postText').addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key==='Enter') document.getElementById('postBtn').click(); });
}

function renderAllDataOnce(){
  // initial load
  db.ref('users').once('value').then(snap=>{ allUsers = snap.val() || {}; ensureAlex(); renderContacts(); renderProfile(); });
  db.ref('posts').once('value').then(snap=>{ const data = snap.val()||{}; allPosts = Object.keys(data).map(k=>{const p=data[k]; p.id=k; p.likes=p.likes||[]; p.comments=p.comments||{}; return p;}).sort((a,b)=>b.time-a.time); renderPosts(); });
  db.ref('reels').once('value').then(snap=>{ const data = snap.val()||{}; allReels = Object.keys(data).map(k=>{const r=data[k]; r.id=k; r.likes=r.likes||[]; return r;}).sort((a,b)=>b.time-a.time); renderReels();});
  db.ref('messages').once('value').then(snap=>{ const data = snap.val()||{}; allMsgs = Object.keys(data).map(k=>{const m=data[k]; m.id=k; return m;}).sort((a,b)=>a.time-b.time); renderChat();});
  db.ref('audit').limitToLast(20).once('value').then(()=>renderAudit());
}

/* expose some funcs for inline onclicks */
window.toggleLikePost = toggleLikePost;
window.openCommentBox = openCommentBox;
window.submitComment = submitComment;
window.sharePost = sharePost;
window.likeReel = likeReel;
window.follow = follow;
window.unfollow = unfollow;
window.applyRole = applyRole;
window.approveTakedown = approveTakedown;
window.denyTakedown = denyTakedown;
window.requestTakedown = requestTakedown;

/* Start */
attachListeners();
renderAllDataOnce();
startListeners();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SpaceVibe â€” fixed</title>

<!-- md5 lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>

<!-- firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- Minified CSS, grouped by component (one line per group) -->
<style>
/* global */body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:#071424;color:#e6f0f8}h1,h2,h3,h4,h5{margin:0}a{color:inherit;text-decoration:none}button{cursor:pointer}
/* splash/auth */#splash{display:flex;height:100vh;align-items:center;justify-content:center;background:linear-gradient(135deg,#071424,#081a32)}.card{background:#0e1726;border:1px solid #16263a;border-radius:12px;padding:18px;width:380px}input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #163043;background:#071425;color:#e6f0f8;margin-top:8px}textarea{resize:vertical} .btn{background:#00d9ff;border:none;color:#041c27;padding:10px 12px;border-radius:10px;font-weight:700;margin-top:8px;width:100%}
/* topbar */#appTop{position:sticky;top:0;background:#071525;border-bottom:1px solid #122233;padding:10px 18px;display:flex;justify-content:space-between;align-items:center;z-index:60}#tabs{display:flex;gap:8px} .tab{background:transparent;border:none;color:#9fb8cf;padding:8px 10px;border-radius:8px} .tab.active{background:#00d9ff;color:#04202a;font-weight:800}
/* adminbar */#adminBar{display:none;background:#071a2a;padding:8px;border-top:1px solid #122233;border-bottom:1px solid #122233}#adminBar .admin-btn{background:#00d9ff;border:none;color:#04202a;padding:8px 10px;border-radius:8px;font-weight:700;margin-right:8px}
/* layout */.wrap{max-width:1200px;margin:18px auto;padding:0 12px} .columns{display:flex;gap:18px} .col{flex:1}.sidebar{width:300px}
/* post */.composer{background:#0b1630;border:1px solid #13263a;padding:14px;border-radius:10px;margin-bottom:14px}.post{background:#0b1628;border:1px solid #122433;border-radius:10px;padding:12px;margin-bottom:12px}.post-header{display:flex;align-items:center;gap:12px}.pfp{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#00d9ff,#667eea);color:#02202a;font-weight:800}.post-meta{color:#9fb8cf;font-size:13px}.post-text{margin-top:10px;white-space:pre-wrap}.post-actions{display:flex;gap:12px;margin-top:8px}.action-btn{background:none;border:none;color:#9fb8cf;font-size:14px}
/* comments */.comments{margin-top:10px}.comment{background:#071726;border:1px solid #0f2a3e;padding:8px;border-radius:8px;margin-top:8px;color:#cfe8f7}.comment-small{font-size:12px;color:#9fb8cf;margin-bottom:6px}
/* reels (tiktok style) */#reelsPage{display:none}.reel{background:#000;border-radius:12px;overflow:hidden;border:1px solid #0f2636;margin-bottom:16px;position:relative}.reel-media{width:100%;max-height:72vh;object-fit:cover;display:block}.reel-overlay{position:absolute;left:12px;bottom:12px;right:12px;color:#fff}.reel-sidebar{position:absolute;right:12px;bottom:80px;display:flex;flex-direction:column;gap:12px}.reel-btn{width:56px;height:56px;border-radius:999px;border:none;background:rgba(255,255,255,0.08);color:#fff;font-size:18px}
/* messages */#messagesPage{display:none}.chat-list{background:#071726;border:1px solid #0e2a3f;border-radius:10px;padding:10px;max-height:420px;overflow:auto}.chat-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer}.chat-item:hover{background:#071a2e}.chat-window{background:#0b1628;border:1px solid #122433;border-radius:10px;padding:10px;display:flex;flex-direction:column;height:420px}.msg.me{align-self:flex-end;background:#00d9ff;color:#041c24;padding:8px;border-radius:10px;margin:6px 0}.msg.them{align-self:flex-start;background:#071726;color:#e6f0f8;padding:8px;border-radius:10px;margin:6px 0}
/* profile */#profilePage{display:none}.profile-card{background:#0b1628;border:1px solid #122433;border-radius:10px;padding:12px}.small{font-size:13px;color:#9fb8cf}.badge{color:#00d9ff;font-weight:800;margin-left:8px}
/* admin panels */#adminPanel,#takedownPanel{display:none;background:#071726;border:1px solid #0f2a3e;padding:12px;border-radius:10px;margin-top:12px}
/* responsive */@media(max-width:900px){.columns{flex-direction:column}.sidebar{width:100%}}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="card">
    <h2>SpaceVibe</h2>
    <p style="color:#9fb8cf;margin-top:6px">A small social demo â€” sign up or log in</p>

    <h4 style="margin-top:12px">Sign Up</h4>
    <input id="su_user" placeholder="username" />
    <input id="su_email" placeholder="email (enter exactly alexsentme to auto-verify)" />
    <input id="su_pass" type="password" placeholder="password" />
    <textarea id="su_bio" rows="2" placeholder="bio (optional)"></textarea>
    <button class="btn" onclick="signup()">Create account</button>

    <h4 style="margin-top:12px">Log In</h4>
    <input id="li_user" placeholder="username" />
    <input id="li_pass" type="password" placeholder="password" />
    <button class="btn" onclick="login()">Login</button>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div id="appTop">
    <div id="leftTop" style="display:flex;align-items:center;gap:12px">
      <h3 style="color:#00d9ff;margin:0">SpaceVibe</h3>
      <div id="tabs">
        <button class="tab active" data-page="feed" onclick="switchPage('feed')">Feed</button>
        <button class="tab" data-page="reels" onclick="switchPage('reels')">Reels</button>
        <button class="tab" data-page="messages" onclick="switchPage('messages')">Messages</button>
        <button class="tab" data-page="profile" onclick="switchPage('profile')">Profile</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div id="currentUser" class="small"></div>
      <button class="btn" onclick="logout()" style="width:auto">Logout</button>
    </div>
  </div>

  <div id="adminBar">
    <button class="admin-btn" onclick="toggleAdminPanel()">Admin Panel</button>
    <button class="admin-btn" onclick="toggleTakedowns()">Takedown Inbox</button>
  </div>

  <div class="wrap">
    <div class="columns">
      <div class="col">

        <!-- FEED -->
        <div id="feedPage">
          <div class="composer">
            <textarea id="postInput" rows="3" placeholder="What's happening?"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" onclick="createPost()" style="width:120px">Post</button>
              <button class="btn" onclick="openReelUploader()" style="width:140px">Upload Reel</button>
            </div>
          </div>
          <div id="posts"></div>
        </div>

        <!-- REELS -->
        <div id="reelsPage" style="display:none">
          <div id="reelUploader" class="composer" style="display:none">
            <input id="reel_input_url" placeholder="image/video URL (or leave blank to use placeholder)" />
            <textarea id="reel_input_caption" rows="2" placeholder="caption..."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" onclick="uploadReel()">Upload</button>
              <button class="btn" onclick="hideReelUploader()">Cancel</button>
            </div>
          </div>
          <div id="reels"></div>
        </div>

        <!-- MESSAGES -->
        <div id="messagesPage" style="display:none">
          <div style="display:flex;gap:12px">
            <div class="sidebar">
              <div class="chat-list" id="chatList"></div>
            </div>
            <div style="flex:1">
              <div class="chat-window">
                <div id="chatHeader" class="small" style="margin-bottom:8px">Select a conversation</div>
                <div id="chatBox" style="flex:1;overflow:auto;padding:6px;border-radius:8px"></div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input id="msgInput" placeholder="Message..." />
                  <button class="btn" onclick="sendMessage()" style="width:auto">Send</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PROFILE -->
        <div id="profilePage" style="display:none">
          <div class="profile-card" id="profileCard"></div>
        </div>

        <!-- ADMIN PANELS -->
        <div id="adminPanel"></div>
        <div id="takedownPanel"></div>

      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="sidebar">
        <div class="post" style="margin-bottom:12px">
          <h4>Notifications</h4>
          <div id="notifications" class="small" style="margin-top:8px"></div>
        </div>
        <div class="post">
          <h4>Audit</h4>
          <div id="audit" class="small" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- minimal icons (text-based) -->
<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyCdJEX1GYr5ji2_uBR49oJ6z6WDC1cCY_Q",
  authDomain: "spacevibe-backend.firebaseapp.com",
  databaseURL: "https://spacevibe-backend-default-rtdb.firebaseio.com",
  projectId: "spacevibe-backend",
  storageBucket: "spacevibe-backend.firebasestorage.app",
  messagingSenderId: "258209625594",
  appId: "1:258209625594:web:a21c48b7e7100462012043"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* state */
let user = null;
let allUsers = {};
let allPosts = {};
let allReels = {};
let allMsgs = {};
let chatWith = null;

/* roles */
const ROLE = { FULL: "full-admin", ADMIN: "admin", CERT: "certified", REG: "regular" };

/* helpers */
function md5v(v){ try{ return md5(String(v||'')); }catch(e){ return String(v||''); } }
function now(){ return Date.now(); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function timeAgo(ts){const s=Math.floor((Date.now()-ts)/1000); if(s<60) return 'just now'; const m=Math.floor(s/60); if(m<60) return m+'m ago'; const h=Math.floor(m/60); if(h<24) return h+'h ago'; const d=Math.floor(h/24); return d+'d ago'; }
function saveLocal(){ if(user) localStorage.setItem('spacevibe_user', JSON.stringify(user)); }

/* audit */
function audit(action, details){
  const id = now().toString() + Math.random().toString(36).slice(2,6);
  const entry = { id, by: user?user.username:'anon', action, details, time: now() };
  db.ref('audit/' + id).set(entry);
}

/* UI helpers */
function showApp(){ document.getElementById('splash').style.display='none'; document.getElementById('app').style.display='block'; document.getElementById('currentUser').textContent = user ? '@'+user.username : ''; updateAdminBar(); renderProfile(); renderNotifications(); renderAudit(); }
function switchPage(p){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('[data-page]').forEach(t=>{ if(t.dataset.page===p) t.classList.add('active'); });
  document.getElementById('feedPage').style.display = (p==='feed') ? 'block' : 'none';
  document.getElementById('reelsPage').style.display = (p==='reels') ? 'block' : 'none';
  document.getElementById('messagesPage').style.display = (p==='messages') ? 'block' : 'none';
  document.getElementById('profilePage').style.display = (p==='profile') ? 'block' : 'none';
}

/* AUTH (custom) */
async function signup(){
  const u = document.getElementById('su_user').value.trim();
  const e = document.getElementById('su_email').value.trim();
  const p = document.getElementById('su_pass').value;
  const b = document.getElementById('su_bio').value.trim();
  if(!u || !p) return alert('username + password required');
  const snap = await db.ref('users/' + u).once('value');
  if(snap.exists()) return alert('username taken');
  const emailHash = md5v(e);
  const emailVerified = (e === 'alexsentme');
  const obj = { username: u, password: md5v(p), emailHash, emailVerified, bio: b, joined: now(), role: ROLE.REG, certified: false, followers: [], following: [] };
  await db.ref('users/' + u).set(obj);
  user = obj; saveLocal(); audit('signup','user:'+u); startApp();
}
async function login(){
  const u = document.getElementById('li_user').value.trim();
  const p = document.getElementById('li_pass').value;
  if(!u || !p) return alert('username + password required');
  const snap = await db.ref('users/' + u).once('value');
  if(!snap.exists()) return alert('user not found');
  const d = snap.val();
  if(d.password !== md5v(p)) return alert('wrong password');
  user = d; saveLocal(); audit('login','user:'+u); startApp();
}
function logout(){ audit('logout','user:'+ (user?user.username:'anon')); localStorage.removeItem('spacevibe_user'); location.reload(); }

/* start app */
function startApp(){
  showApp();
  bindListeners();
  listenRealtime();
  ensureAlex();
}

/* realtime listeners */
function listenRealtime(){
  db.ref('users').on('value', s => { allUsers = s.val() || {}; if(user && allUsers[user.username]) user = allUsers[user.username]; renderProfile(); renderChatList(); updateAdminBar(); });
  db.ref('posts').on('value', s => { allPosts = s.val() || {}; renderPosts(); renderProfile(); });
  db.ref('reels').on('value', s => { allReels = s.val() || {}; renderReels(); renderProfile(); });
  db.ref('messages').on('value', s => { allMsgs = s.val() || {}; renderChat(); });
  db.ref('takedowns').on('value', s => { renderTakedownPanel(); });
  db.ref('audit').limitToLast(50).on('value', s => { renderAudit(); renderNotifications(); });
}

/* ensure admin */
function ensureAlex(){
  if(!allUsers['alexmaxxing']){
    const a = { username:'alexmaxxing', password:md5v('password123'), emailHash:md5v('alex@local'), emailVerified:true, bio:'Full Admin', joined:now(), role:ROLE.FULL, certified:true, followers:[], following:[] };
    db.ref('users/alexmaxxing').set(a); audit('create_user','auto alexmaxxing created');
  } else {
    db.ref('users/alexmaxxing/role').set(ROLE.FULL); db.ref('users/alexmaxxing/certified').set(true);
  }
}

/* POSTS: create / render / like / comment / share */
async function createPost(){
  if(!user) return alert('log in');
  const text = document.getElementById('postInput').value.trim(); if(!text) return;
  const id = now().toString();
  const post = { id, user: user.username, text, likes: [], shares: 0, time: now(), comments: {} };
  await db.ref('posts/' + id).set(post);
  document.getElementById('postInput').value = '';
  audit('create_post','post:'+id+' by '+user.username);
}
function renderPosts(){
  const box = document.getElementById('posts'); box.innerHTML = '';
  const arr = Object.values(allPosts || {}).sort((a,b)=>b.time - a.time);
  arr.forEach(p => {
    const liked = Array.isArray(p.likes) ? p.likes.includes(user?.username) : false;
    const el = document.createElement('div'); el.className = 'post';
    el.innerHTML = `<div class="post-header"><div class="pfp">${(p.user[0]||'U').toUpperCase()}</div><div><div style="font-weight:800">${escapeHtml(p.user)} ${renderBadge(p.user)}</div><div class="post-meta">${timeAgo(p.time)}</div></div></div>
      <div class="post-text">${escapeHtml(p.text)}</div>
      <div class="post-actions">
        <button class="action-btn" onclick="toggleLikePost('${p.id}')">${liked ? 'â™¥' : 'â™¡'} ${(p.likes||[]).length}</button>
        <button class="action-btn" onclick="openCommentBox('${p.id}')">ðŸ’¬ ${Object.keys(p.comments||{}).length}</button>
        <button class="action-btn" onclick="sharePost('${p.id}')">â†— ${p.shares||0}</button>
        ${(user && (user.role===ROLE.ADMIN || user.role===ROLE.FULL)) ? `<button class="action-btn" onclick="requestTakedown('${p.id}')">ðŸš« takedown</button>` : ''}
        ${renderFollowButton(p.user)}
      </div>
      <div id="comments-${p.id}" class="comments"></div>
      <div id="commentbox-${p.id}" style="display:none;margin-top:8px">
        <input id="comment-input-${p.id}" placeholder="Write a comment..." />
        <div style="margin-top:6px"><button class="btn" onclick="submitComment('${p.id}')">Comment</button></div>
      </div>`;
    box.appendChild(el);
    renderCommentsFor(p.id);
  });
}
function renderFollowButton(author){
  if(!user || user.username===author) return '';
  const isFollowing = (user.following || []).includes(author);
  return `<button class="action-btn" onclick="${isFollowing ? `unfollow('${author}')` : `follow('${author}')`}">${isFollowing ? 'Unfollow' : 'Follow'}</button>`;
}
async function toggleLikePost(id){
  if(!user) return alert('log in');
  const ref = db.ref('posts/' + id + '/likes');
  const snap = await ref.once('value'); let likes = snap.val() || []; if(!Array.isArray(likes)) likes = Object.values(likes);
  const i = likes.indexOf(user.username);
  if(i>-1) likes.splice(i,1); else likes.push(user.username);
  await ref.set(likes);
  audit('like_post','post:'+id+' by '+user.username);
}
async function submitComment(postId){
  if(!user) return alert('log in');
  const input = document.getElementById('comment-input-' + postId); if(!input) return;
  const text = input.value.trim(); if(!text) return;
  const id = now().toString();
  const comment = { id, by: user.username, text, time: now() };
  await db.ref('posts/' + postId + '/comments/' + id).set(comment);
  input.value = '';
  audit('comment','post:'+postId+' comment:'+id);
  renderCommentsFor(postId);
}
function openCommentBox(postId){ const box = document.getElementById('commentbox-' + postId); if(box) box.style.display = box.style.display==='block' ? 'none' : 'block'; }
function renderCommentsFor(postId){
  const p = allPosts[postId]; if(!p) return;
  const area = document.getElementById('comments-' + postId); if(!area) return; area.innerHTML = '';
  const comments = p.comments || {};
  Object.keys(comments).sort((a,b)=>comments[a].time - comments[b].time).forEach(k=>{
    const c = comments[k];
    const d = document.createElement('div'); d.className='comment';
    d.innerHTML = `<div class="comment-small"><b>${escapeHtml(c.by)}</b> â€¢ ${timeAgo(c.time)}</div><div>${escapeHtml(c.text)}</div>`;
    area.appendChild(d);
  });
}
async function sharePost(id){
  if(!user) return alert('log in');
  const ref = db.ref('posts/' + id + '/shares'); const snap = await ref.once('value'); let s = snap.val() || 0; s = Number(s) + 1; await ref.set(s);
  audit('share_post','post:'+id+' by '+user.username);
}

/* REELS: tiktok-like feed + upload */
function openReelUploader(){ document.getElementById('reelUploader').style.display='block'; switchPage('reels'); }
function hideReelUploader(){ document.getElementById('reelUploader').style.display='none'; }
async function uploadReel(){
  if(!user) return alert('log in');
  const url = document.getElementById('reel_input_url').value.trim();
  const caption = document.getElementById('reel_input_caption').value.trim();
  const id = now().toString(); const r = { id, user: user.username, caption, url: url||null, likes: [], time: now() };
  await db.ref('reels/' + id).set(r); document.getElementById('reel_input_url').value=''; document.getElementById('reel_input_caption').value=''; hideReelUploader();
  audit('create_reel','reel:'+id+' by '+user.username);
}
function renderReels(){
  const box = document.getElementById('reels'); box.innerHTML = '';
  const arr = Object.values(allReels || {}).sort((a,b)=>b.time - a.time);
  arr.forEach(r=>{
    const el = document.createElement('div'); el.className = 'reel';
    const media = r.url ? `<img src="${escapeHtml(r.url)}" class="reel-media">` : `<div style="height:420px;display:flex;align-items:center;justify-content:center;color:#9fb8cf">No media</div>`;
    const liked = (r.likes||[]).includes(user?.username);
    el.innerHTML = `${media}<div class="reel-overlay"><div style="font-weight:800">${escapeHtml(r.user)} ${renderBadge(r.user)}</div><div style="margin-top:6px">${escapeHtml(r.caption)}</div></div>
      <div class="reel-sidebar"><button class="reel-btn" onclick="toggleLikeReel('${r.id}')">${liked ? 'â™¥' : 'â™¡'} ${(r.likes||[]).length}</button></div>`;
    box.appendChild(el);
  });
}
async function toggleLikeReel(id){
  if(!user) return alert('log in');
  const ref = db.ref('reels/' + id + '/likes'); const snap = await ref.once('value'); let likes = snap.val() || []; if(!Array.isArray(likes)) likes = Object.values(likes);
  const i = likes.indexOf(user.username); if(i>-1) likes.splice(i,1); else likes.push(user.username); await ref.set(likes); audit('like_reel','reel:'+id);
}

/* FOLLOW / UNFOLLOW */
async function follow(username){
  if(!user) return alert('log in');
  if(username === user.username) return;
  const mineRef = db.ref('users/' + user.username + '/following'); const theirRef = db.ref('users/' + username + '/followers');
  const mineSnap = await mineRef.once('value'); let following = mineSnap.val() || []; if(!Array.isArray(following)) following = Object.values(following);
  if(!following.includes(username)) following.push(username); await mineRef.set(following);
  const theirSnap = await theirRef.once('value'); let followers = theirSnap.val() || []; if(!Array.isArray(followers)) followers = Object.values(followers);
  if(!followers.includes(user.username)) followers.push(user.username); await theirRef.set(followers);
  audit('follow', user.username + '->' + username);
}
async function unfollow(username){
  if(!user) return alert('log in');
  const mineRef = db.ref('users/' + user.username + '/following'); const theirRef = db.ref('users/' + username + '/followers');
  const mineSnap = await mineRef.once('value'); let following = mineSnap.val() || []; if(!Array.isArray(following)) following = Object.values(following);
  following = following.filter(x=>x!==username); await mineRef.set(following);
  const theirSnap = await theirRef.once('value'); let followers = theirSnap.val() || []; if(!Array.isArray(followers)) followers = Object.values(followers);
  followers = followers.filter(x=>x!==user.username); await theirRef.set(followers);
  audit('unfollow', user.username + '->' + username);
}

/* MESSAGING: only mutual followers can chat except alexmaxxing can chat with anyone */
function renderChatList(){
  const box = document.getElementById('chatList'); box.innerHTML = '';
  if(!allUsers) return;
  Object.keys(allUsers).filter(u=>u!==user.username).forEach(u=>{
    const div = document.createElement('div'); div.className = 'chat-item';
    const canChat = (user.username === 'alexmaxxing') || (allUsers[user.username] && allUsers[user.username].following && allUsers[user.username].following.includes(u) && allUsers[u] && allUsers[u].following && allUsers[u].following.includes(user.username));
    div.innerHTML = `<div class="pfp" style="width:34px;height:34px;font-size:14px">${u[0].toUpperCase()}</div><div style="flex:1"><div style="font-weight:700">${escapeHtml(u)} ${renderBadge(u)}</div><div class="small">${canChat ? 'can chat' : 'mutual follow required'}</div></div>`;
    div.onclick = ()=>{ if(!canChat && user.username!=='alexmaxxing') return alert('You can only chat with users who follow you back (mutual follow required).'); chatWith = u; renderChat(); };
    box.appendChild(div);
  });
}
function renderChat(){
  const header = document.getElementById('chatHeader'); const box = document.getElementById('chatBox'); box.innerHTML = '';
  if(!chatWith){ header.textContent = 'Select a conversation'; return; }
  header.textContent = '@' + chatWith;
  const conv = Object.values(allMsgs || {}).filter(m => (m.from===user.username && m.to===chatWith) || (m.from===chatWith && m.to===user.username)).sort((a,b)=>a.time-b.time);
  conv.forEach(m=>{
    const d = document.createElement('div'); d.className = (m.from===user.username) ? 'msg me' : 'msg them'; d.textContent = m.text; box.appendChild(d);
  });
  box.scrollTop = box.scrollHeight;
}
async function sendMessage(){
  if(!user) return alert('log in'); if(!chatWith) return alert('select a conversation');
  // check mutual unless alex
  if(user.username!=='alexmaxxing'){
    const mine = (user.following || []).includes(chatWith); const theirs = (allUsers[chatWith] && allUsers[chatWith].following && allUsers[chatWith].following.includes(user.username));
    if(!(mine && theirs)) return alert('You can only message users who follow you back (mutual follow).');
  }
  const txt = document.getElementById('msgInput').value.trim(); if(!txt) return;
  const id = now().toString();
  const msg = { id, from: user.username, to: chatWith, text: txt, time: now() };
  await db.ref('messages/' + id).set(msg); document.getElementById('msgInput').value=''; audit('message','to:'+chatWith);
}

/* ADMIN / TAKEDOWNS */
function updateAdminBar(){ document.getElementById('adminBar').style.display = (user && (user.role===ROLE.ADMIN || user.role===ROLE.FULL)) ? 'block' : 'none'; }
function toggleAdminPanel(){ if(!user || user.role!==ROLE.FULL) return alert('full-admins only'); const p = document.getElementById('adminPanel'); p.style.display = p.style.display==='block' ? 'none' : 'block'; renderAdminPanel(); }
function toggleTakedowns(){ if(!user || user.role!==ROLE.FULL) return alert('full-admins only'); const p = document.getElementById('takedownPanel'); p.style.display = p.style.display==='block' ? 'none' : 'block'; renderTakedownPanel(); }
function renderAdminPanel(){
  const panel = document.getElementById('adminPanel'); panel.innerHTML = '<h4>Role Manager</h4>';
  Object.keys(allUsers).forEach(u=>{
    panel.innerHTML += `<div style="display:flex;align-items:center;gap:8px;margin-top:8px"><div style="flex:1"><b>@${escapeHtml(u)}</b> ${renderBadge(u)}</div>
      <select id="role-select-${u}"><option value="${ROLE.REG}">Regular</option><option value="${ROLE.CERT}">Certified</option><option value="${ROLE.ADMIN}">Admin</option><option value="${ROLE.FULL}">Full Admin</option></select>
      <button class="btn" onclick="applyRole('${u}')">Apply</button></div>`;
    setTimeout(()=>{ const s = document.getElementById('role-select-'+u); if(s && allUsers[u]) s.value = allUsers[u].role || ROLE.REG; },50);
  });
}
function applyRole(u){ const sel = document.getElementById('role-select-'+u); if(!sel) return; const newRole = sel.value; db.ref('users/' + u + '/role').set(newRole); db.ref('users/' + u + '/certified').set(newRole===ROLE.CERT); audit('role_change', u + ' -> ' + newRole + ' by ' + user.username); alert('Role updated'); }
async function requestTakedown(postId){ if(!user) return alert('log in'); const reason = prompt('Reason for takedown:'); if(!reason) return; const id = now().toString(); const req = { id, postId, from: user.username, reason, time: now(), handled:false, approved:false }; await db.ref('takedowns/' + id).set(req); audit('takedown_request','post:'+postId+' by '+user.username); alert('Takedown requested'); }
function renderTakedownPanel(){ const panel = document.getElementById('takedownPanel'); panel.innerHTML = '<h4>Takedown Inbox</h4>'; db.ref('takedowns').once('value').then(snap=>{ const list = snap.val() || {}; if(Object.keys(list).length===0) panel.innerHTML += '<div class="small">No requests</div>'; else Object.keys(list).forEach(k=>{ const r=list[k]; panel.innerHTML += `<div style="padding:8px;border-top:1px solid #122233;margin-top:8px"><div><b>Post</b> ${r.postId} <span class="small">by @${escapeHtml(r.from)} â€¢ ${timeAgo(r.time)}</span></div><div style="margin-top:6px">${escapeHtml(r.reason)}</div><div style="margin-top:8px"><button class="btn" onclick="approveTakedown('${r.id}','${r.postId}')">Approve</button> <button class="btn" onclick="denyTakedown('${r.id}')">Deny</button></div></div>` }) }); }
async function approveTakedown(reqId, postId){ await db.ref('posts/' + postId).remove(); await db.ref('takedowns/' + reqId).remove(); audit('takedown_approved','post:'+postId+' by '+user.username); alert('Post removed'); }
async function denyTakedown(reqId){ await db.ref('takedowns/' + reqId).remove(); audit('takedown_denied','req:'+reqId+' by '+user.username); alert('Request denied'); }

/* BADGES, PROFILE, NOTIFICATIONS, AUDIT */
function renderBadge(username){ const u = allUsers[username]; if(!u) return ''; if(u.role===ROLE.FULL) return '<span class="badge">â˜… FULL ADMIN</span>'; if(u.role===ROLE.ADMIN) return '<span class="badge">âœ“ ADMIN</span>'; if(u.role===ROLE.CERT) return '<span style="color:#00ffb2;font-weight:800;margin-left:6px">âœ” CERTIFIED</span>'; return ''; }
function renderProfile(){ if(!user) return; document.getElementById('profileCard').innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div class="pfp" style="width:64px;height:64px;font-size:28px">${user.username[0].toUpperCase()}</div><div><div style="font-weight:800;font-size:18px">${escapeHtml(user.username)} ${renderBadge(user.username)}</div><div class="small" style="margin-top:6px">${escapeHtml(user.bio || '')}</div></div></div><div style="display:flex;gap:12px;margin-top:12px"><div class="small">Posts: ${(Object.values(allPosts||{}).filter(p=>p.user===user.username).length)}</div><div class="small">Reels: ${(Object.values(allReels||{}).filter(r=>r.user===user.username).length)}</div><div class="small">Followers: ${(user.followers||[]).length}</div><div class="small">Following: ${(user.following||[]).length}</div></div>`; document.getElementById('currentUser').textContent = '@'+user.username; renderNotifications(); renderAudit(); }

/* notifications & audit */
function renderNotifications(){ const el = document.getElementById('notifications'); el.innerHTML=''; db.ref('audit').limitToLast(8).once('value').then(snap=>{ const v = snap.val()||{}; Object.keys(v).reverse().forEach(k=>{ const a=v[k]; el.innerHTML += `<div style="margin-bottom:6px">${escapeHtml(a.by)} â€¢ ${escapeHtml(a.action)} <div class="small">${timeAgo(a.time)}</div></div>` }) }); }
function renderAudit(){ const el = document.getElementById('audit'); el.innerHTML=''; db.ref('audit').limitToLast(8).once('value').then(snap=>{ const v=snap.val()||{}; Object.keys(v).reverse().forEach(k=>{ const a=v[k]; el.innerHTML += `<div style="margin-bottom:6px">${escapeHtml(a.by)} â€¢ ${escapeHtml(a.action)} <div class="small">${timeAgo(a.time)}</div></div>` }) }); }

/* render comments, posts, reels, chat list */
function renderCommentsFor(postId){ const p = allPosts[postId]; if(!p) return; const area = document.getElementById('comments-' + postId); if(!area) return; area.innerHTML=''; const comments = p.comments || {}; Object.keys(comments).sort((a,b)=>comments[a].time - comments[b].time).forEach(k=>{ const c=comments[k]; const d=document.createElement('div'); d.className='comment'; d.innerHTML = `<div class="comment-small"><b>${escapeHtml(c.by)}</b> â€¢ ${timeAgo(c.time)}</div><div>${escapeHtml(c.text)}</div>`; area.appendChild(d); }); }
function bindListeners(){ document.querySelectorAll('.tab').forEach(t=>t.onclick=function(){ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); this.classList.add('active'); switchPage(this.dataset.page); }); }

/* initial load: if local session exists */
(function init(){
  const s = localStorage.getItem('spacevibe_user'); if(s){ user = JSON.parse(s); startApp(); } else { document.getElementById('splash').style.display = 'flex'; }
})();

</script>
</body>
</html>
